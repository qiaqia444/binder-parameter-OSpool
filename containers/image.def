Bootstrap: docker
From: julia:1.11

%files
   Project.toml /opt/project/
   Manifest.toml /opt/project/

%post
    # Install any needed system packages first
    apt-get update -y
    apt-get install -y wget \
            git \
            cmake \
            g++ \
            build-essential

    # Set up Julia environment
    export JULIA_DEPOT_PATH="/opt/julia"
    mkdir -p /opt/julia
    
    # Install Julia packages in the project environment first
    cd /opt/project
    julia --project=. -e 'using Pkg; println("Installing project packages..."); Pkg.instantiate(); Pkg.precompile(); println("Project packages installed successfully!")'
    
    # Test that packages load correctly
    julia --project=. -e 'using ITensors, ITensorMPS, ITensorCorrelators, ArgParse, JSON; println("All packages loaded successfully!")'

%environment
    export JULIA_DEPOT_PATH="/opt/julia"
    export JULIA_PROJECT="/opt/project"
