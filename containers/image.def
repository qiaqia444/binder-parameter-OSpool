Bootstrap: docker
From: julia:1.11

%files
   Project.toml /opt/project/
   Manifest.toml /opt/project/

%post
    # Install any needed system packages first
    apt-get update -y
    apt-get install -y wget \
            git \
            cmake \
            g++ \
            build-essential \
            ca-certificates

    # Set up Julia environment
    export JULIA_DEPOT_PATH="/opt/julia"
    mkdir -p /opt/julia
    
    # Install Julia packages in the project environment
    cd /opt/project
    echo "Installing packages from Manifest.toml..."
    julia --project=. -e 'using Pkg; println("Julia version: ", VERSION); println("Installing packages..."); Pkg.instantiate(); println("Precompiling..."); Pkg.precompile(); println("Done!")'
    
    # Test that packages load correctly
    echo "Testing package loading..."
    julia --project=. -e 'using ITensors; println("✓ ITensors loaded"); using ITensorMPS; println("✓ ITensorMPS loaded"); using ITensorCorrelators; println("✓ ITensorCorrelators loaded"); using ArgParse, JSON; println("✓ All packages loaded successfully!")'

%environment
    export JULIA_DEPOT_PATH="/opt/julia"
    export JULIA_PROJECT="/opt/project"
